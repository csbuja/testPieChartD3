<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Testing D3</title>

        <script src='http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js'> </script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src='http://cdnjs.cloudflare.com/ajax/libs/seedrandom/2.3.6/seedrandom.min.js'></script>
        <!--<script type="text/javascript" src="d3/d3.js"></script>-->
        <style>
        </style>
    </head>
    <body>
        <script type="text/javascript">
        	$(document).ready(function(){
              //seeds the random numberGenerator
              Math.seedrandom('hello.');

              if(!pieTracker){
                var pieTracker = {};
              }

              var numSections = 7;
              var jobs_colors = getRandomColors(numSections);  var jobs_colors = getRandomColors(numSections);
            
              var innerRadius = 0;
              var outerRadius = 130;
              var width       = 800;
              var height      = 500;

              
              var textArray = [];

              for( var i = 0; i< numSections; ++i)
               {
                   textArray.push('name' + (i+1))
               }
               console.log(textArray);

              var pie = d3.layout.pie()
                          .sort(null);
                     
              var arc = d3.svg.arc()
                          .innerRadius(innerRadius)
                          .outerRadius(outerRadius);

              var svg = d3.select("body").append("svg")
                                         .attr("width", width)
                                         .attr("height", height)
              var thepie =      svg.append("g")
                                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

              $(window).on('pieTrackerFormed', function(event, data){               
                   var group = thepie.selectAll("g").data(pie(arrayOfOnes(data.numSections)));
                   var arcgroup=         group.enter().append('g');
                   

                   var path = arcgroup.append("path")
                           .attr("fill", "#fff")
                           .attr("d", arc)
                           .each(function(d) { this._current = d;  }); // store the initial values

                   var slicelabels = arcgroup.append('text')
                                     .attr("transform", function(d) {                    //set the label's origin to the center of the arc
                                    //we have to make sure to set these before calling arc.centroid
                                    /*d.innerRadius = 200;
                                    d.outerRadius = 400;
                                    return "translate(" + arc.centroid(d) + ")";        //this gives us a pair of coordinates like [50, 50]*/
                                     var c = arc.centroid(d);
                                     return "translate(" + c[0]*2 +"," + c[1]*2 + ")";
                                     })
                                     .text('hahaha');

                   /*svg.selectAll('text').data(textArray)
                          .append('svg:text')
                          .attr('fill', 'red')
                          .attr('font-size', '20px');
                          .text(function(d,i){textArray[i];})*/
                   


                    $(window).trigger("startPieWorker", [{svg:data.svg, arc:arc, pie:pie, jobs_colors: data.colorList, numSections: data.numSections, path: path, jobs_counts: data.mapData}] );
              });

              //when the new pieTracker is made, make the graph
              $(window).on("startPieWorker",  worker);
              
              //a loop to start making a new piegraph
              setInterval( function(){ newPieTracker(textArray, jobs_colors, getRandomCounts(textArray.length), thepie );}, 3000);
              function newPieTracker(nameList, colorList, mapData, svg){
                  if(!((nameList.length === colorList.length) && ( colorList.length === mapData.length) ))
                  {
                    throw{
                          error: 'Error'   ,
                          msg: 'argument lengths are different when forming new pieTracker'
                    }
                  }
                  var aPieTracker = function(){
                    var temp = {};
                    
                    temp.numSections = nameList.length;
                    temp.nameList = nameList;
                    temp.colorList = colorList;
                    temp.mapData = mapData;
                    temp.svg = svg

                    temp.map = {};
                    //make hashMap
                    /*for(var i = 0; i < nameList.length; ++i)
                    {
                      temp.map[nameList[i]] = {color: colorList[i], data:mapData[i]}
                    }*/

                    return temp;
                  }()

                  //trigger event that includes the PieTracker
                  $(window).trigger('pieTrackerFormed', [aPieTracker]);
              }

              function worker(event, data) {
                  var svg = data.svg;
                  var arc  = data.arc;
                  var pie  = data.pie;
                  var jobs_colors = data.jobs_colors;
                  var numSections = data.numSections;
                  var path = data.path;
                  var jobs_counts = data.jobs_counts;
                  
                  /*console.log(jobs_counts)
                  var sum = 0;
                  $(jobs_counts).each(function(i,value){
                    sum+=value; 
                  });
                  console.log('sum: ' + sum); */

                  path = path.data(pie(jobs_counts))
                             .attr("fill", function(d,i) {return jobs_colors[i]});
                  path.transition().duration(750).attrTween("d", arcTween); // redraw the arcs

                  // Store the displayed angles in _current.
                  // Then, interpolate from _current to the new angles.
                  // During the transition, _current is updated in-place by d3.interpolate.
                  function arcTween(a) {
                      var i = d3.interpolate(this._current, a);
                      this._current = i(0);
                      return function(t) {
                          return arc(i(t));
                      };
                  }
              }           

              function addRandomColor(list){
                  list.push('#'+Math.floor(Math.random()*16777215).toString(16));
              }            

              //takes in a numberOfColors
              //returns an Array of Random Colors if
              function getRandomColors(numColors){
                  if(numColors<0){
                      throw{
                          error: 'Error'   ,
                          msg: 'numColors in the getRandomColors can\'t be negative'
                      }
                  }
                  else{
                    var theArray = [] ;
                    for(var i = 0; i< numColors; ++i)
                    {
                      addRandomColor(theArray); 
                     
                    }
                    return theArray;
                  }
              }

              function getRandomCounts(numSections) {
                  var arr = [];
                  for (var i=0;i<numSections;i++) {
                     arr.push(Math.floor(Math.random()*10)+1);
                  }
                  return (arr);
              }     
              function arrayOfOnes(numSections){
                return Array.apply(null, new Array(numSections)).map(Number.prototype.valueOf,1);    
              }

              //takes in an array of names, colors and Data
              //when done emits an event called 'pieTrackerFormed' which includes the pieTracker data
             

        	});
            
            


        </script>
    </body>
</html>